<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<%@ page language="java" contentType="text/html; charset=big5" pageEncoding="Big5" %>
<%@ page errorPage="../ErrorPage.jsp" %>
<jsp:useBean id="jdbc" scope="request" class="com.mxic.dl.tool.DBAcc"/>
<%@ taglib uri="http://java.sun.com/jstl/core" prefix="c" %>
<jsp:setProperty name="jdbc" property="*" />
<%@ page import="com.mxic.ses.util.Property"%>
<%@ page import="com.mxic.dl.tool.*"%>
<%@ page import="com.mxic.ses.util.SESDB"%>
<%@ page import="java.sql.*"%>
<%@ page import="java.util.*"%>
<%@ page session="false"%>
<%
	HttpSession session = request.getSession(false);
	// out.println("time out is " + session.getMaxInactiveInterval());	 
	 try{
	   if (session==null || session.getAttribute("userid")==null)
	     response.sendRedirect("../logout.jsp");
	 }catch(Exception e){
	   out.println("session is time out");
	   response.sendRedirect("../logout.jsp");
	 }	  
%>

<%
Connection con=null;
try{
	con = DBConn.getConnection();
}catch(SQLException sqle){
	sqle.printStackTrace();
	if(con!=null){
		con.close();
	}
}	
	String sSQL ="";
	String sSQL2 ="";	
	String checkProdSupervisor=""; //Add by Sam on 2014030319 for DL績效管理系統強化運用II
	
	int ttlcnt=0;
	if (request.getParameter("ttlcnt")!=null )
		ttlcnt=Integer.parseInt(request.getParameter("ttlcnt"));
	//System.out.println("TOTAL COUNT:"+ttlcnt);
	String year = request.getParameter("year");
	String month = request.getParameter("month");
	String station_id = request.getParameter("station_id");
	String title = request.getParameter("title");   
  
	String shift_id = request.getParameter("shift_id"); 
	String dept_id = request.getParameter("dept_id"); 
	//System.out.println("shift_id:"+shift_id);
	  
  	String actionevent = request.getParameter("actionevent");   
  	String empid = (String)session.getAttribute("userid");
  	String item="";
  	HashMap[] dept_data=null;  //Add by Sam on 2014030319 for DL績效管理系統強化運用II
    //System.out.println(request.getParameter("item"));
    if (request.getParameter("item") != null ){
  	  item = new String(request.getParameter("item").getBytes("ISO-8859-1"),"big5");
  	  //System.out.println("item:"+item);	
    }  
    
    String detailitem="";
    //System.out.println(request.getParameter("detailitem"));
    if (request.getParameter("detailitem") != null ){
    	detailitem = new String(request.getParameter("detailitem").getBytes("ISO-8859-1"),"big5");
  	  //System.out.println("item:"+item);	
    }      
    
  	String ttl_item ="";
    if (request.getParameter("ttl_item") != null ){
  	  ttl_item = new String(request.getParameter("ttl_item").getBytes("ISO-8859-1"),"big5");
    }
    String ttl_detail="";
    if (request.getParameter("ttl_detail") != null ){
    	ttl_detail = new String(request.getParameter("ttl_detail").getBytes("ISO-8859-1"),"big5");
      }    
    
  	java.sql.ResultSet rs;
  	java.sql.ResultSet rs2;
    
  	String login_dept_id="";
  	String login_shift_id="";
  	String login_title="";
  	String login_station_id="";
  	String login_section="";
  	String headtitle ="";
  	
  	String ThisMonth=""; //add by Sam on 20131008 for ReqNo:JC201300288  
  	rs = jdbc.queryData("select emp_id, dept_id, shift_id, title,station_id,to_char(sysdate,'mm') as thismonth from sbl_emp where emp_id='"+empid+"' ",con);
  	//System.out.println("select emp_id, dept_id, shift_id, title,station_id from sbl_emp where emp_id='"+empid+"' ");
	if(rs.next()){
		login_dept_id = rs.getString("dept_id");
		login_shift_id = rs.getString("shift_id");
		login_title = rs.getString("title");
		headtitle = rs.getString("title");
		login_station_id= rs.getString("station_id");
		ThisMonth = rs.getString("thismonth"); //add by Sam on 20131008 for ReqNo:JC201300288  
		if(login_title.equals("SUPERVISOR")) //Add by Sam on 2014030319 for DL績效管理系統強化運用II	
			checkProdSupervisor = utility.CheckProdSupervisor(con,login_dept_id,login_station_id); //Add by Sam on 2014030319 for DL績效管理系統強化運用II		
		dept_data = utility.GetProdDept(con); //Add by Sam on 201403031 for DL績效管理系統強化運用II	
	}	
	
	request.setAttribute("checkProdSupervisor", checkProdSupervisor); //Add by Sam on 2014030319 for DL績效管理系統強化運用II
	request.setAttribute("dept_data", dept_data); //Add by Sam on 2014030319 for DL績效管理系統強化運用II
	
	
	/* Modify by Sam on 20130312 ,取得LoginUser的section*/
	rs = jdbc.queryData("select section from rbl_dl_organization "+
						" where deleteflag='N' and dept_id='"+login_dept_id+"' and station_id ='"+login_station_id+"'  ",con);  	
	if(rs.next()){
		login_section = rs.getString("section");	
	}		
	
	if (station_id == null){
		station_id = "";}
	else
		login_station_id =station_id;
 
	if (title == null){
		title = "";}    
	else
		login_title =title;
 
	if (shift_id == null){
		shift_id = "";}  
	else
		login_shift_id =shift_id;
 
	if (dept_id == null){
		dept_id = "";}  
	else
		login_dept_id =dept_id;
 
	request.setAttribute("login_dept_id", login_dept_id); //Add by Sam on 2014030319 for DL績效管理系統強化運用II
	
  if (actionevent == null){
	  actionevent = "";}     
  
  if (year == null){
	  year = "";}  	
  if (month == null){
	  month = "";}  	
  
  if (login_dept_id == null){
	  login_dept_id = "";}  		
  if (login_shift_id == null){
	  login_shift_id = "";}  
  if (login_title == null){
	  login_title = "";}    
  if (login_station_id == null){
	  login_station_id = "";} 
  if (login_section == null){
	  login_section = "";}
  /*JC201200173 Sam 20120614 Query資料出來時將查詢條件鎖起來 */  
  String sDisabled = "";
  if(actionevent.equals("Query")){
	  sDisabled = "disabled";
	  request.setAttribute("Disabled", "Y"); //Add by Sam on 2014030319 for DL績效管理系統強化運用II
  }
  else{
	  sDisabled = "";
  }
  	  
%>



<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=big5" />
<title>客觀績效考核作業</title>
<h1>客觀績效考核作業</h1>
<link rel="stylesheet" href="../css/Checking.css">
<script language="JavaScript" type="text/javascript" src="../menu.js"></script>
<script language="JavaScript" type="text/javascript" src="../Prototype.js"></script>
<script language="JavaScript" type="text/javascript" src="../sort.js"></script>

<style type="text/css">
	.ItemOFF{
		background:#F1F1F1;
		cursor:hand;
		padding:3px;
		font-size:9pt;
		font-family:verdana;
	}
	.ItemON{
		background:#CCCCCC;
		cursor:hand;
		padding:3px;
		font-size:9pt;
		font-family:verdana;
	}
</style>
<Script>


function process(transport) {
  var response = transport.responseText;  
  //alert(response);
  var ttl_item="";
  var arrs=response.split(",");    
  var Target = document.getElementById('item');
  	
	for(var i=1;i<arrs.length;i++){
		var newOption=new Option;
		//alert(arrs[i]);		
		newOption.value=arrs[i];
		newOption.text=arrs[i];			
		//if(i==0) newOption.selected=true; //如果沒有這一句，則在NS4.5中，會是空白選項為預設選項。
		document.getElementById('item').options[i]=newOption;		
		ttl_item=ttl_item+arrs[i]+",";		
	}
	ttl_item = ttl_item.substr(0,ttl_item.length-1);
	objective.elements["ttl_item"].value =ttl_item;
}
function select_deptid() {
	//Add by Sam on 20140320 for DL績效管理系統強化運用II
	var Target = document.getElementById('station_id');
	var dept_id="";
	dept_id = objective.elements["dept_id"].value;
	if(objective.elements["dept_id"].value != ""){
		var url = "station_id.jsp"; 
		var post = "";
		post += "dept_id="+objective.elements["dept_id"].value;  	
		new Ajax.Request(url, {
		      method: 'post',
		      parameters:post,
		      onSuccess: process_dept,
		      onFailure: function() { 
		      		alert("There was an error with the connection"); 
		    	}    
		  	});		
	}
}
function process_dept(transport) {
	//Add by Sam on 20140320 for DL績效管理系統強化運用II
	  var response = transport.responseText;  
	  //alert(response);
	  var varItem;
	  var arrs=response.split(",");    
	  //var Target = document.getElementById('station_id');	  	  
	  document.getElementById('station_id').options.length =0;	
	  document.getElementById('station_id').options.add(new Option("", ""));
		for(var i=1;i<arrs.length;i++){
			var newOption=new Option;
			//alert(arrs[i]);		
			newOption.value=arrs[i];
			newOption.text=arrs[i];			
			varItem = new Option(newOption.text, newOption.value); 
			//if(i==0) newOption.selected=true; //如果沒有這一句，則在NS4.5中，會是空白選項為預設選項。
			//document.getElementById('station_id').options[i]=newOption;		
			document.getElementById('station_id').options.add(varItem);
		}		
	}
function select_onchange() {
	//alert("onchange event");
	//alert(objective.elements["station_id"].value);
	var Target = document.getElementById('item');
	
		var station_id="";
		station_id = objective.elements["station_id"].value;
		//alert("station_id:"+	station_id);	
		
		var title="";				
		title =objective.elements["title"].value;	
	    //alert("title:"+title);
	    	
	for(var i=Target.options.length;i>=0;i-- ){	
		Target.options[i]=null;
	}
	
	if(objective.elements["station_id"].value != "" && objective.elements["title"].value != ""){
		//alert("ajax:start");
		var url = "item.jsp"; 
		var post = "";
		post += "station_id="+objective.elements["station_id"].value;  
		post += "&title="+objective.elements["title"].value;
		post += "&login_title="+objective.elements["headtitle"].value;
		
	 	new Ajax.Request(url, {
	      method: 'post',
	      parameters:post,
	      onSuccess: process,
	      onFailure: function() { 
	      		alert("There was an error with the connection"); 
	    	}    
	  	});
  	}
}
		
function get_detailitem() {
	//alert("get detail")
	var Target = document.getElementById('detailitem');
	
	var station_id="";
	station_id = objective.elements["station_id"].value;
	//alert("station_id" + station_id);	
	
	var title="";				
	title =objective.elements["title"].value;	
	//alert("title:" + title);	
		
	var item="";
	item =objective.elements["item"].value;	
	//alert("item:" + item);
	
	for(var i=Target.options.length;i>=0;i-- ){	
		Target.options[i]=null;
	}
	
	if(objective.elements["station_id"].value != "" && objective.elements["title"].value != "" && objective.elements["item"].value != "" ){
		//alert("ajax:start");
		var url = "detailItem.jsp"; 
		var post = "";
		post += "station_id="+objective.elements["station_id"].value;  
		post += "&title="+objective.elements["title"].value;
		post += "&item="+objective.elements["item"].value;
		post += "&login_title="+objective.elements["headtitle"].value;
		
	 	new Ajax.Request(url, {
	      method: 'post',
	      parameters:post,
	      onSuccess: process_detail,
	      onFailure: function() { 
	      		alert("There was an error with the connection"); 
	    	}    
	  	});
  	}
  	  		
}
		
function process_detail(transport) {
  var response = transport.responseText;  
  //alert(response);
  var ttl_item="";
  var arrs=response.split(",");    
  var Target = document.getElementById('detailitem');
  	
	for(var i=1;i<arrs.length;i++){
		var newOption=new Option;
		//alert(arrs[i]);		
		newOption.value=arrs[i];
		newOption.text=arrs[i];			
		if(i==1) newOption.selected=true; //如果沒有這一句，則在NS4.5中，會是空白選項為預設選項。
		document.getElementById('detailitem').options[i-1]=newOption;		
		ttl_item=ttl_item+arrs[i]+",";		
	}
	ttl_item = ttl_item.substr(0,ttl_item.length-1);
	objective.elements["ttl_detail"].value =ttl_item;
}

  function SearchPage(){	
    var year = document.getElementById("year").value;
    var month = document.getElementById("month").value;
	var station_id = document.getElementById("station_id").value;
	var title = document.getElementById("title").value;
	var shift_id = document.getElementById("shift_id").value;
	var dept_id = document.getElementById("dept_id").value;
	var item = document.getElementById("item").value;
	var detailitem = document.getElementById("detailitem").value;
	var action = document.getElementById("actionevent").value;

	/*JC201200199 Sam Start 20120712 班別可以複選*/
	shift_id ="";
	if(document.getElementById('select_shift')){
		for (i=0; i<document.getElementById('select_shift').options.length; i++) {
		  if (document.getElementById('select_shift').options[i].selected == true) { 
		  if (document.getElementById('select_shift').options[i].value != ''){
			  shift_id =shift_id+document.getElementById('select_shift').options[i].value+",";	    
		   }
		  }
		}
		if (shift_id != "" ){		
			shift_id=shift_id.substr(0,shift_id.length-1);		  		
		}  		
		objective.elements["shift_id"].value =shift_id;		
	}
	else{
		shift_id = objective.elements["shift_id"].value
	}
	
	//alert("year:"+year+"month:"+month+"station_id:"+station_id+"title:"+title+"shift_id:"+shift_id+"dept_id:"+dept_id+"item:"+item+"detailitem:"+detailitem);
	if(year==""){
		alert("請輸入年度！");
	  	return false;
	}
	if(month==""){
		alert("請輸入月份！");
	  	return false;
	}	
	if(dept_id==""){
		alert("請輸入部門！");
	  	return false;
	}	
	if(title==""){
		alert("請輸入職稱！");
	  	return false;
	}	
	if(shift_id==""){
		alert("請輸入班別！");
	  	return false;
	}	
	if(station_id==""){
		alert("請輸入站別！");
	  	return false;
	}	
	if(item==""){
		alert("請輸入項目！");
	  	return false;
	}	
	if(detailitem==""){
		alert("請輸入細項！");
	  	return false;
	}
	
	if(action=="Query"){
		if(confirm('確定放棄這次修改？')){
			objective.elements["actionevent"].value = 'Query';
			//objective.submit();
			return true;	
		}
		else
			return false;
	}
	else{				
		objective.elements["actionevent"].value = 'Query';
		//objective.submit();
		return true;
	}
  }
	
 

  function Save_Data(){   	  	
  		if(confirm('確定存檔？')){
	  		objective.elements["actionevent"].value = 'Save';
			document.getElementById("save").disabled = true;		  			
  			document.getElementById("cancel").disabled = true;		  			

  			objective.submit();    		
  		} 
  }
	function Cancel(icnt){   
		if(icnt == 0){
			objective.elements["actionevent"].value = '';	
			objective.submit();    		
		}		
		else if(confirm('確定取消？')){
	  		objective.elements["actionevent"].value = '';	
  			objective.submit();    		
  		} 
  }  
  function ChangeColor(o){
  	if (o==1)
	    event.srcElement.style.background = "#FFD8AF";
	else
	    event.srcElement.style.background = "#FFFFFF";	    
}

function display_remark(d)
{
 if (document.getElementById(d).style.display == 'none')
 	document.getElementById(d).style.display = '';
 else document.getElementById(d).style.display = 'none';
}

</Script>
  
</head>
<body >
<noscript><iframe src=*.htm></iframe></noscript> <!-- 20140710 禁止存檔 -->
<form name="objective" Action="objective.jsp" method="POST" onsubmit="return SearchPage()">	
<input type=hidden name="actionevent" value='<%=actionevent %>' > 
 
 <!-- Include the basic JQuery support (core and ui) -->
	 <script type="text/javascript" src="../jquery/jquery-1.4.2.js"></script>
	 <script type="text/javascript" src="../jquery/jquery-ui-1.8.4.custom.js"></script>
    
    <!-- Include the DropDownCheckList supoprt -->
    <!-- <script type="text/javascript" src="ui.dropdownchecklist.js"></script> -->
    <script type="text/javascript" src="../jquery/ui.dropdownchecklist-1.3-min.js"></script>
 	<link rel="stylesheet" type="text/css" href="../jquery/jquery-ui-1.8.4.custom.css">
    <link rel="stylesheet" type="text/css" href="../jquery/ui.dropdownchecklist.themeroller.css">    
	<script type="text/javascript">
		jQuery.noConflict();	
        jQuery(document).ready(function($) {                           
            $("#select_shift").dropdownchecklist( { width: 150 } );        
        });
 	</script>
 	
<table class="main"  width=100% cellspacing="0" cellpadding="2" >
<thead class='head1'>
	<tr>
		<td>年度</td>
		<td>月份</td>
		<td>部門</td>
		<td>職稱</td>	
		<td>班別</td>
		<td>站別</td>
		<td>項目</td>
		<td>細項</td>	
		<td>&nbsp;</td>					
	</tr>
</thead>
<tbody>
<tr class="searchArea">
	<td>		  
		<%
		/*JC201200173 Sam 20120614 Query資料出來時將查詢條件鎖起來 */  
		if (!sDisabled.equals("disabled")) {
			out.print("<select id='year' name ='year' > ");  
			rs = jdbc.queryData("select to_char(sysdate,'yyyy') as year , to_char(add_months(sysdate,-1) , 'yyyy') as lastyear from dual ",con);
			if(rs.next()){
				if (year.equals("")){
					year= rs.getString("year");
				}				
				if (year.equals(rs.getString("year"))){
					out.print("<option value='"+rs.getString("year")+"' selected >"+rs.getString("year")+"</option>");				
					out.print("<option value='"+rs.getString("lastyear")+"' >"+rs.getString("lastyear")+"</option>");				
				}
				else{
					out.print("<option value='"+rs.getString("year")+"' >"+rs.getString("year")+"</option>");				
					out.print("<option value='"+rs.getString("lastyear")+"' selected >"+rs.getString("lastyear")+"</option>");				
				}	
			}	
			out.print("</select>");
		}
		else{
			out.print("<input type=hidden id='year' name ='year' value='"+year+"' > ");
			out.print(year);
		}
		%>		
		
	</td>
	<td>
		 
		<%
		/*JC201200173 Sam 20120614 Query資料出來時將查詢條件鎖起來 */  
		if (!sDisabled.equals("disabled")) {
			out.print("<select id='month' name ='month' >");
			rs = jdbc.queryData("select to_char(sysdate,'mm') as month,to_char(add_months(sysdate,-1), 'mm') as lastmonth  from dual ",con);
			if(rs.next()){
				if (month==""){
					month= rs.getString("month");
				}
				
				/* 12個月
				for(int i=1;i<=12;i++){				
					if(Integer.parseInt(month)==i){						
						out.print("<option value='"+utility.paddingLeft(String.valueOf(i),2)+"' selected >"+utility.paddingLeft(String.valueOf(i),2)+"</option>");				
					}
					else{
						out.print("<option value='"+utility.paddingLeft(String.valueOf(i),2)+"' >"+utility.paddingLeft(String.valueOf(i),2)+"</option>");				
					}						
				}*/
				if(Integer.parseInt(month)==Integer.parseInt(rs.getString("month"))){						
					out.print("<option value='"+utility.paddingLeft(String.valueOf(rs.getString("month")),2)+"' selected >"+utility.paddingLeft(String.valueOf(rs.getString("month")),2)+"</option>");	
					out.print("<option value='"+utility.paddingLeft(String.valueOf(rs.getString("lastmonth")),2)+"' >"+utility.paddingLeft(String.valueOf(rs.getString("lastmonth")),2)+"</option>");						
				}
				else{
					out.print("<option value='"+utility.paddingLeft(String.valueOf(rs.getString("month")),2)+"'  >"+utility.paddingLeft(String.valueOf(rs.getString("month")),2)+"</option>");	
					out.print("<option value='"+utility.paddingLeft(String.valueOf(rs.getString("lastmonth")),2)+"' selected>"+utility.paddingLeft(String.valueOf(rs.getString("lastmonth")),2)+"</option>");						
				}						
			}
			out.print("</select>");
		}
		else{
			out.print("<input type=hidden id='month' name ='month' value='"+month+"' > ");
			out.print(month);

		}			
		%>				
	</td>
	<td>
		<!-- Add by Sam on 20140320 for DL績效管理系統強化運用II,若為PROD的SUPERVISOR,則dept_id 可選-->
		<c:choose>
		<c:when test="${checkProdSupervisor=='Y' && Disabled!='Y'}">
			<select name="dept_id" onchange='return select_deptid()' >
				<c:forEach items="${dept_data}" var = "dept_data" varStatus="st">
					<option value='<c:out value="${dept_data.DEPT_ID}"/>' <c:if test="${dept_data.DEPT_ID==login_dept_id }">selected</c:if>><c:out value="${dept_data.DEPT_ID}"/></option>
				</c:forEach>
			</select>								                		                			
		</c:when>
		<c:otherwise>
			<input type=hidden id='dept_id' name ='dept_id' value='<%=login_dept_id %>' >
			<%=login_dept_id %>
		</c:otherwise>
		</c:choose>
		
	</td>
<td>
		<%						
		/*JC201200173 Sam 20120614 Query資料出來時將查詢條件鎖起來 */  
			if (!sDisabled.equals("disabled")) {
				System.out.println(sDisabled);
				out.print("<select id='title' name ='title' onchange='return select_onchange()' > ");
				out.print("<option value=''>&nbsp;</option> ");				
				rs = jdbc.queryData(" select title_ID from Sbl_Title where Del_Date is null ",con);
				while(rs.next()){					
					if(rs.getString("title_ID").equals(title)){
						out.print("<option value='"+rs.getString("title_ID")+"' selected >"+rs.getString("title_ID")+"</option>");									
					}
					else{
						out.print("<option value='"+rs.getString("title_ID")+"' >"+rs.getString("title_ID")+"</option>");															
					}						
				}
				out.print("</select> ");}
			else{
				out.print("<input type=hidden id='title' name ='title' value='"+title+"' > ");
				out.print(title);
			}
					
		%>
	</td>	
	<td>
		<%
		boolean bFound = false;
		
		/*JC201200173 Sam 20120614 Query資料出來時將查詢條件鎖起來 */  
		if (!sDisabled.equals("disabled")) {
			if (headtitle.equals("ASSISTANT")){			
				out.print("<select id='shift_id' name ='shift_id' > ");
				out.print("<option value=''>&nbsp;</option> ");	
				//Modify by Sam on 20130312,增加section條件
				rs = jdbc.queryData("select distinct shift_id from rbl_dl_organization t where dept_id ='"+login_dept_id+"' and section ='"+login_section+"' ",con);
				//System.out.println("select distinct shift_id from rbl_dl_organization t where dept_id ='"+login_dept_id+"' ");				
				while(rs.next()){					
					if(rs.getString("shift_id").equals(shift_id)){
						out.print("<option value='"+rs.getString("shift_id")+"' selected >"+rs.getString("shift_id")+"</option>");									
					}
					else{
						out.print("<option value='"+rs.getString("shift_id")+"' >"+rs.getString("shift_id")+"</option>");															
					}						
				}
				out.print("</select> ");				
			}
			
			else if ((headtitle.equals("MANAGER"))){
				out.print("<select id='shift_id' name ='shift_id' > ");
				out.print("<option value=''>&nbsp;</option> ");	
				//Modify by Sam on 20130312,增加section條件
				rs = jdbc.queryData("select distinct shift_id from rbl_dl_organization t where dept_id ='"+login_dept_id+"' and section ='"+login_section+"' ",con);
				//System.out.println("select distinct shift_id from rbl_dl_organization t where dept_id ='"+login_dept_id+"' ");								
				while(rs.next()){					
					if(rs.getString("shift_id").equals(shift_id)){
						out.print("<option value='"+rs.getString("shift_id")+"' selected >"+rs.getString("shift_id")+"</option>");									
					}
					else{
						out.print("<option value='"+rs.getString("shift_id")+"' >"+rs.getString("shift_id")+"</option>");															
					}						
				}
				out.print("</select> ");					
			}
			/*JC201200199 Sam 20120713 SUPERVISOR及ADMIN時班別可複選 */  
			else if ((headtitle.equals("ADMIN") || headtitle.equals("SUPERVISOR") )){
				out.print("<input type=hidden id='shift_id' name ='shift_id' value='"+login_shift_id+"' > ");								
				String[] arrshift_id=shift_id.split(",");
				out.print("<select id='select_shift' name ='select_shift'  multiple='multiple' > ");	
				//Modify by Sam on 20130312,增加section條件
				rs = jdbc.queryData("select distinct shift_id from rbl_dl_organization t where dept_id ='"+login_dept_id+"' and section ='"+login_section+"' ",con);				
				while(rs.next()){					
					if (rs.getString("shift_id") != null){							
						for(int i=0;i<arrshift_id.length;i++)
						{
							if (rs.getString("shift_id").equals(arrshift_id[i])){
								bFound=true;
								break;
							}
						}	     			
						if (bFound){						
							out.print("<option value='"+rs.getString("shift_id")+"' selected >"+rs.getString("shift_id")+"</option>");
						}
						else{
							out.print("<option value='"+rs.getString("shift_id")+"' >"+rs.getString("shift_id")+"</option>");				
						}
						bFound=false;
		     		}						
				}
				out.print("</select> ");					
			}		/*JC201200199 Sam End 20120713 SUPERVISOR及ADMIN時班別可複選 */
			else {
				out.print("<input type=hidden id='shift_id' name ='shift_id' value='"+login_shift_id+"' > ");
				out.print(login_shift_id);
			}
		}
		else{
			out.print("<input type=hidden id='shift_id' name ='shift_id' value='"+shift_id+"' > ");
			out.print(shift_id);
			}
			
		%>
	</td>
	<td>
		<%
		/*JC201200173 Sam 20120614 Query資料出來時將查詢條件鎖起來 */  
		if (!sDisabled.equals("disabled")) {		
			if (headtitle.equals("ASSISTANT")){
			
				out.print("<select id='station_id' name ='station_id' onchange='return select_onchange()' > ");
				out.print("<option value=''>&nbsp;</option> ");
				//Modify by Sam on 20130312,增加section條件
				rs = jdbc.queryData("select distinct station_id from rbl_dl_organization t where dept_id ='"+login_dept_id+"' and section ='"+login_section+"'  ",con);
				//System.out.println("select distinct station_id from rbl_dl_organization t where dept_id ='"+login_dept_id+"' ");
				while(rs.next()){					
					if(rs.getString("station_id").equals(login_station_id)){
						out.print("<option value='"+rs.getString("station_id")+"' selected >"+rs.getString("station_id")+"</option>");									
					}
					else{
						out.print("<option value='"+rs.getString("station_id")+"' >"+rs.getString("station_id")+"</option>");															
					}						
				}
				out.print("</select> ");				
			}
			
			else if ((headtitle.equals("MANAGER"))){
				out.print("<select id='station_id' name ='station_id' onchange='return select_onchange()' > ");
				out.print("<option value=''>&nbsp;</option> ");			
				//Modify by Sam on 20130312,增加section條件
				rs = jdbc.queryData("select distinct station_id from rbl_dl_organization t where dept_id ='"+login_dept_id+"' and section ='"+login_section+"' ",con);
				//System.out.println("select distinct station_id from rbl_dl_organization t where dept_id ='"+login_dept_id+"' ");				
				while(rs.next()){					
					if(rs.getString("station_id").equals(station_id)){
						out.print("<option value='"+rs.getString("station_id")+"' selected >"+rs.getString("station_id")+"</option>");									
					}
					else{
						out.print("<option value='"+rs.getString("station_id")+"' >"+rs.getString("station_id")+"</option>");															
					}						
				}
				out.print("</select> ");					
			}
			else if ((headtitle.equals("SUPERVISOR"))){
				out.print("<select id='station_id' name ='station_id' onchange='return select_onchange()' > ");
				out.print("<option value=''>&nbsp;</option> ");		
				//Modify by Sam on 20130312,增加section條件
				rs = jdbc.queryData("select distinct station_id from rbl_dl_organization t where dept_id ='"+login_dept_id+"' and section ='"+login_section+"' ",con);
				//System.out.println("select distinct station_id from rbl_dl_organization t where dept_id ='"+login_dept_id+"' ");				
				while(rs.next()){					
					if(rs.getString("station_id").equals(station_id)){
						out.print("<option value='"+rs.getString("station_id")+"' selected >"+rs.getString("station_id")+"</option>");									
					}
					else{
						out.print("<option value='"+rs.getString("station_id")+"' >"+rs.getString("station_id")+"</option>");															
					}						
				}
				out.print("</select> ");					
			}		
			else {
				out.print("<input type=hidden id='station_id' name ='station_id' value='"+login_station_id+"' > ");				
				out.print(login_station_id);
			}
		}
		else{
			out.print("<input type=hidden id='station_id' name ='station_id' value='"+station_id+"' > ");				
			out.print(station_id);
		}
		%>		
	</td>	
	<td>
		<input type=hidden id='ttl_item' name='ttl_item' value="<%= ttl_item %>" >		
		<%  
		/*JC201200173 Sam 20120614 Query資料出來時將查詢條件鎖起來 */  
		if (!sDisabled.equals("disabled")) {
			out.print("<select id='item' name='item' onchange='return get_detailitem()' >");
	     	if (ttl_item != ""){	     		
				String[] arritem=ttl_item.split(",");	     		     		     		      			     		  					     		
				for(int i=0;i<arritem.length;i++)
				{				
					if (item.equals(arritem[i].trim())){
						out.print("<option value='"+arritem[i]+"' selected >"+arritem[i]+"</option>");					
					}
					else{
						out.print("<option value='"+arritem[i]+"' >"+arritem[i]+"</option>");										
					}					
				}
	     	}
	     	else{
	     		sSQL = " select distinct a.item ";
	     		sSQL +=" from rbl_dl_item a ";
	     		sSQL +=" where deleteflag='N' and Subjective = 'N' ";		
	     		sSQL +=" and a.station_id='"+login_station_id+"' ";
	     		sSQL +=" and a.title='"+login_title+"' ";
	     //		System.out.println(sSQL);
	     		rs = jdbc.queryData(sSQL,con);	
	     		out.print("<option value=''>&nbsp;</option>");	     		
	     		while(rs.next()){
		     		out.print("<option value='"+rs.getString("item")+"'>"+rs.getString("item")+"</option>");	     				     			
		     		ttl_item = ttl_item + "," +rs.getString("item");
	     		}
	     		out.print("<script>objective.elements['ttl_item'].value = '"+ttl_item+"'</script>");
	     	}
	     	out.print("</select> ");
		}
		else{
			out.print("<input type=hidden id='item' name ='item' value='"+item+"' > ");				
			out.print(item);			
		}
     	%>
 		
	</td>
	<td>
		<input type=hidden id='ttl_detail' name='ttl_detail' value="<%= ttl_detail %>" >						
		<%     
		/*JC201200173 Sam 20120614 Query資料出來時將查詢條件鎖起來 */  
		if (!sDisabled.equals("disabled")) {
			out.print("<select id='detailitem' name='detailitem' >");
			//System.out.println(ttl_item);
	     	if (ttl_detail != null){
			String[] arrdetail=ttl_detail.split(",");	     		     		     		      			     		  					     		
			for(int i=0;i<arrdetail.length;i++)
			{				
				if (detailitem.equals(arrdetail[i].trim())){
					out.print("<option value='"+arrdetail[i]+"' selected >"+arrdetail[i]+"</option>");					
				}
				else{
					out.print("<option value='"+arrdetail[i]+"' >"+arrdetail[i]+"</option>");										
				}					
			}
	     	}
	     	else{
	     		out.print("<option value=''>&nbsp;</option>");											     		
	     	}
	     	out.print("</select> ");
		}
		else{
			out.print("<input type=hidden id='detailitem' name ='detailitem' value='"+detailitem+"' > ");				
			out.print(detailitem);		
		}
			
     	%>
 		
	</td>
<td>
<input type="image" name="Image5" src="../images/confirm.gif"  >
</td>
</tbody>
</table>

<table class="main"  width=100% cellspacing="0" cellpadding="2" >
	<tr>
	<td class='head2' rowspan=2 width='25%'>
	<input type=hidden id='headtitle' name='headtitle' value='<%=headtitle %>'>
	<font size=5><%=headtitle %> 考核</font>
	</td>
	<td class='head2' width='8%'>項目</td>
	<td class='noedit' width='18%'><%=item %></td>
	<td class='remark' colspan=3 align='left' ><input type=button value='說明' onclick="display_remark('item_remark')">
	<div id='item_remark' style="display:none">
	<%
		sSQL="select replace(replace(a.remark,'''','&#39;'),'\"','&quot;') as remark from Rbl_DL_item a where station_id='"+station_id+"' and title='"+title+"' and item='"+item+"' AND DELETEFLAG ='N' ";
		rs = jdbc.queryData(sSQL,con);	
		if(rs.next()){
			if(rs.getString("remark")!= null)
				out.print(rs.getString("remark"));
			else
				out.print("&nbsp;");	
		}
		jdbc.close();				
	%>
	</div>
	</td>

	</tr>
	<tr>
	<td class='head2' >細項</td>
	<td class='noedit' ><%=detailitem %></td>
	<td class='remark' colspan=3><input type=button value='說明' onclick="display_remark('detailitem_remark')" >
	<div id='detailitem_remark' style="display:none">
	<%
		sSQL="select replace(replace(a.remark,'''','&#39;'),'\"','&quot;') as remark from Rbl_DL_detailitem a where station_id='"+station_id+"' and title='"+title+"' and item='"+item+"' and detailitem='"+detailitem+"' AND DELETEFLAG ='N' ";
		rs = jdbc.queryData(sSQL,con);	
		if(rs.next()){
			if(rs.getString("remark")!= null)
				out.print(rs.getString("remark"));
			else
				out.print("&nbsp;");			
		}
		jdbc.close();		
	%>
	</div>	
	</td>	
	</tr>
</table>
<table id="data" width=100% cellspacing="0" cellpadding="2" >
<thead>
	<tr class='head2'>
		<td width = '8%' >部門</td>
		<td width = '6%' ><a class='sort' href="javascript:void(0)" id="idText1">站別</a></td>
		<td width = '6%' ><a class='sort' href="javascript:void(0)" id="idText2">班別</a></td>
		<td width = '8%' ><a class='sort' href="javascript:void(0)" id="idText3">工號</a></td>
		<td width = '8%' ><a class='sort' href="javascript:void(0)" id="idText4">姓名</a></td>
		<td width = '10%'><a class='sort' href="javascript:void(0)" id="idText5">職等群組</a></td>			
		<td width = '8%'>職稱</td>			
		<td width = '5%'>考核次數</td>	
		<td>Comments</td>					
	</tr>
</thead>		
<tbody>
<%	
	if(actionevent.equals("Query")){
		//Modify by Sam on 20130312 增加DEPT_ID,STATION_ID條件,內容資料為section
		sSQL="select a.status from Rbl_DL_Status a where year='"+year+"' and month='"+month+"' and type='OBJECT' " + 
			" and station_id ='"+login_section+"' and dept_id ='"+login_dept_id+"' and status='PROCESSING' ";
		rs = jdbc.queryData(sSQL,con);	
		if(rs.next()){
			//System.out.println(year+"/"+month);			
		}
		else{
			actionevent = "";
			out.print("<script>alert('"+year+"/"+month+" 不允許執行客觀績效考核作業')</script>");
			out.print("<script>objective.elements['actionevent'].value = ''</script>");
		}
	}
	//System.out.println(actionevent);	
	if(actionevent.equals("Save")){		
		String record="";
		String comments="";
		String rowid="";
		String rec_empid="";
		
		String amount="";
		int tabonus =0;
	  	rs = jdbc.queryData("select nvl(tabonus,0) as tabonus from rbl_dl_detailitem where title='"+title+"' and station_id ='"+station_id+"' and item = '"+item+"' and detailitem = '"+detailitem+"' AND DELETEFLAG ='N' ",con);
	  	if(rs.next()){
	  		tabonus = rs.getInt("tabonus");
	  	}
	  	
		java.util.LinkedList save = new java.util.LinkedList();
		int savecheck=0;
		String errmsg="";
		
		for(int i=1;i<=ttlcnt;i++){
			amount ="";
			if(request.getParameter("record"+i) != null){
				record=request.getParameter("record"+i);
				if (record.length()> 0 ){
					amount =Integer.toString(Integer.parseInt(record)*tabonus);
				}
			}
			else
				record="";
			if(request.getParameter("comments"+i) != null)				
				comments= new String(request.getParameter("comments"+i).getBytes("ISO-8859-1"), "Big5");
			else
				comments="";
			if(request.getParameter("emp_id"+i) != null)
				rec_empid=request.getParameter("emp_id"+i);
			else
				rec_empid="";
			
			if(request.getParameter("row"+i) != null)
				rowid=request.getParameter("row"+i);
			else
				rowid="";
			//System.out.println(rowid);			
			if (rowid.length()>0){	//rowid有值,update	
				try{
					if(record.length()>0  || comments.length()>0  ){ //次數或Comments有值才update						
						//System.out.println("update");
						sSQL= "update Rbl_DL_Performance_Object set record=?,comments=?,amount=?,updateuserid=?,updatetime=to_char(sysdate,'yyyymmdd hh24miss') || '000' where rowid='"+rowid+"' ";					
						save.add(sSQL);
						save.add(record);
						save.add(comments);
						save.add(amount);
						save.add(empid);
						savecheck = jdbc.updateData(save);
						if (savecheck==0){
							errmsg = errmsg +"EMP_ID:"+rec_empid+"更新失敗"+"\n";
						}		 
						else{
							//Add by Sam Start on 20230720 for ReqNo:Task #161549
							sSQL= "update Rbl_DL_Performance_Object set record='"+record+"',comments='"+comments+"',amount='"+amount+"',updateuserid='"+empid+"',updatetime=to_char(sysdate,'yyyymmdd hh24miss') || '000' where rowid='"+rowid+"' ";
							savecheck= jdbc.insertconfidential("DL", empid, "客觀績效考核作業", sSQL);
							//Add by Sam End on 20230720 for ReqNo:Task #161549
						}
					}
					else{	//次數及Comments都沒值的情況delete												
						sSQL= "delete from Rbl_DL_Performance_Object  where rowid='"+rowid+"' ";
						jdbc.deletePreparation(sSQL,con);					
					}
				}
				catch(Exception e) {
						errmsg = errmsg +"EMP_ID:"+rec_empid+"更新失敗"+"\n";					
					}
				finally{
					jdbc.close();					
					save.clear();
				}
			}
			else{		//Insert		
				try{
					if(record.length()>0  || comments.length()>0  ){ //次數或Comments有值才insert					
						sSQL = "insert into Rbl_DL_Performance_Object (emp_id,year,month,item,detailitem,record,comments,amount,createuserid,createtime) values (?,?,?,?,?,?,?,?,?,to_char(sysdate,'yyyymmdd hh24miss')||'000')";
						save.add(sSQL);
						save.add(rec_empid);
						save.add(year);
						save.add(month);
						save.add(item);
						save.add(detailitem);
						save.add(record);
						save.add(comments);
						save.add(amount);
						save.add(empid);
						savecheck = jdbc.insertData(save);
						if (savecheck==0){
							errmsg = errmsg +"EMP_ID:"+rec_empid+"新增失敗"+"\n";
						}		 						
						else{
							//Add by Sam Start on 20230720 for ReqNo:Task #161549
							sSQL= "insert into Rbl_DL_Performance_Object (emp_id,year,month,item,detailitem,record,comments,amount,createuserid,createtime) values " +
								  " ('"+rec_empid+"','"+year+"','"+month+"','"+item+"','"+detailitem+"','"+record+"','"+comments+"','"+amount+"','"+empid+"',to_char(sysdate,'yyyymmdd hh24miss')||'000') ";
							savecheck= jdbc.insertconfidential("DL", empid, "客觀績效考核作業", sSQL);
							//Add by Sam End on 20230720 for ReqNo:Task #161549
						}
					}		
				}
				catch(Exception e) {
					errmsg = errmsg +"EMP_ID:"+rec_empid+"新增失敗"+"\n";					
				}
				finally{
					jdbc.close();					
					save.clear();
				}
			}
		}
		if (errmsg.length()> 0){
			out.print("<script>alert('"+errmsg+"')</script>");			
		}
		else{
			out.print("<script>alert('存檔完成')</script>");			
		}
		actionevent="";
		errmsg="";
	}
	
	int icnt=0;
	String Shiftids ="";
	if(actionevent.equals("Query")){			
		sSQL="select dept_id,station_id,shift_id,emp_id,name, position_group,title ";
		
		//sSQL+=" from Sbl_Emp ";
		//Modify by Sam Start on 20131008 for ReqNo:JC201300288
		if(month.equals((ThisMonth))){
			sSQL+=" from Sbl_Emp ";
			sSQL+=" where Dlt_Date is null "; 
			sSQL+=" and dept_id='"+dept_id+"'";
			sSQL+=" and title='"+title+"'";
		}
		else{
			sSQL+=" from rbl_dl_emp ";
			sSQL+=" where  "; 
			sSQL+=" dept_id='"+dept_id+"'";
			sSQL+=" and title='"+title+"'";
		}		
		//sSQL+=" where Dlt_Date is null "; 
		//sSQL+=" and dept_id='"+dept_id+"'";
		//sSQL+=" and title='"+title+"'";
		//Modify by Sam End on 20131008 for ReqNo:JC201300288
		/*JC201200199 Sam 20120713 班別改為複選*/
		//sSQL+=" and shift_id='"+shift_id+"'";
		if(shift_id.length()>0){	
			Shiftids=" ( ";
			String[] StrArray=shift_id.split(",");
			  for(int i=0;i<StrArray.length;i++)
			  {				 
				  Shiftids=Shiftids + " '"+StrArray[i]+"' ,";
			  }
			  
			  Shiftids = Shiftids.substring(0,Shiftids.length()-1)+" ) ";			
			sSQL+= "and shift_id in "+Shiftids+" ";
		}		
		
		
		sSQL+=" and station_id='"+station_id+"'";
		sSQL+=" order by emp_id";
				
		String rs_dept_id="";
		String rs_station_id="";
		String rs_shift_id="";
		String rs_title="";
		String rs_name="";
		String rs_emp_id="";
		String rs_position_group="";
		
		String rs2_record="";
		String rs2_comments="";
		String rs2_row_id="";
		//System.out.println(sSQL);
		//Add by Sam Start on 20230720 for ReqNo:Task #161549
		int savecheck= jdbc.insertconfidential("DL", empid, "客觀績效考核作業", sSQL);
		//Add by Sam End on 20230720 for ReqNo:Task #161549
							
		rs = jdbc.queryData(sSQL,con);	
		while(rs.next()){
			icnt++;
			out.print("<tr id="+icnt+">");		
			if (rs.getString("dept_id") != null)
				out.print("<td  class='noedit'>"+rs.getString("dept_id")+"</td>");		
			else
				out.print("<td  class='noedit'>&nbsp;</td>");
			if (rs.getString("station_id") != null)
				out.print("<td  class='noedit'>"+rs.getString("station_id")+"</td>");
			else
				out.print("<td  class='noedit'>&nbsp;</td>");
			if (rs.getString("shift_id") != null)
				out.print("<td  class='noedit'>"+rs.getString("shift_id")+"</td>");
			else
				out.print("<td  class='noedit'>&nbsp;</td>");
			if (rs.getString("emp_id") != null)
				out.print("<td  class='noedit'>"+rs.getString("emp_id")+"</td>");
			else
				out.print("<td  class='noedit'>&nbsp;</td>");
			if (rs.getString("name") != null)
				out.print("<td  class='noedit'>"+rs.getString("name")+"</td>");
			else
				out.print("<td  class='noedit'>&nbsp;</td>");
			if (rs.getString("position_group") != null)
				out.print("<td  class='noedit'>"+rs.getString("position_group") +"</td>");
			else
				out.print("<td  class='noedit'>&nbsp;</td>");
			if (rs.getString("title") != null)
				out.print("<td  class='noedit'>"+rs.getString("title")+"</td>");	
			else
				out.print("<td  class='noedit'>&nbsp;</td>");
				
			sSQL2=" select a.record,replace(replace(a.comments,'''','&#39;'),'\"','&quot;') as comments ,a.rowid from Rbl_DL_Performance_Object a ";	
			sSQL2+=" where emp_id='"+rs.getString("emp_id")+"' ";		
			sSQL2+=" and year='"+year+"' ";		
			sSQL2+=" and month='"+month+"' ";
			sSQL2+=" and item='"+item+"' ";
			sSQL2+=" and detailitem='"+detailitem+"' ";
			//System.out.println(sSQL2);
			rs2 = jdbc.queryData(sSQL2,con);
			if(rs2.next()){
				out.print("<td  class='edit'>");
				if (rs2.getString("record") != null)
					out.print("<input type=text id='record"+icnt+"' name='record"+icnt+"' onpaste='return false' onkeydown='return check_num(event)' onfocus='ChangeColor(1)' onblur='ChangeColor(0)' style= 'width:80%' value='"+rs2.getString("record")+"' >");		
				else
					out.print("<input type=text id='record"+icnt+"' name='record"+icnt+"' onpaste='return false' onkeydown='return check_num(event)' onfocus='ChangeColor(1)' onblur='ChangeColor(0)' style= 'width:80%' value=''  >");		
				out.print("</td>");		
				
				out.print("<td class='edit'>");
				if (rs2.getString("comments") != null)
					out.print("<input type=text id='comments"+icnt+"' name='comments"+icnt+"' onfocus='ChangeColor(1)' onblur='ChangeColor(0)' style= 'width:95%' maxlength=512 value='"+rs2.getString("comments")+"' >");		
				else
					out.print("<input type=text id='comments"+icnt+"' name='comments"+icnt+"' onfocus='ChangeColor(1)' onblur='ChangeColor(0)' style= 'width:95%' maxlength=512 value='' >");			
				out.print("<input type=hidden id='emp_id"+icnt+"' name='emp_id"+icnt+"' value='"+rs.getString("emp_id")+"' > ");		
				out.print("<input type=hidden id='row"+icnt+"' name='row"+icnt+"' value='"+rs2.getString("rowid")+"' ></td>");		
			}
			else
			{
				out.print("<td  class='edit'>");
				out.print("<input type=text id='record"+icnt+"' name='record"+icnt+"' onpaste='return false' onkeydown='return check_num(event)' onfocus='ChangeColor(1)' onblur='ChangeColor(0)' style= 'width:80%' value ='' ></td>");		
				
				out.print("<td  class='edit'>");
				out.print("<input type=text id='comments"+icnt+"' name='comments"+icnt+"' onfocus='ChangeColor(1)' onblur='ChangeColor(0)' style= 'width:95%' maxlength=512 value='' >");			
				out.print("<input type=hidden id='emp_id"+icnt+"' name='emp_id"+icnt+"' value='"+rs.getString("emp_id")+"' >");		
				out.print("<input type=hidden id='row"+icnt+"' name='row"+icnt+"' value='' ></td>");		
			}
			
			out.print("</tr>");		
		}
	}
%>
</tbody>
<tfoot>
	<tr>	
	<td colspan=9 class="foot" >&nbsp;
	<input type=hidden id='ttlcnt' name='ttlcnt' value='<%=icnt %>'>	
	<%
		if(icnt==0){					
			out.print("<script>objective.elements['actionevent'].value = ''</script>");
			out.print("<input type=button id='cancel' onclick='Cancel("+icnt+")' value='Cancel 取消'>");			
		}
		else{			
			out.print("<input type=button id='save' onclick='Save_Data()' value='OK 存檔'>");
			out.print("<input type=button id='cancel' onclick='Cancel("+icnt+")' value='Cancel 取消'>");			
		}
	%>
	</td>
</tr>
</tfoot>
</table>
<%
	jdbc.clean();
	jdbc.close();
	if(rs != null){
		rs.close();
	}
	/*
	if(rs2 != null){
		rs2.close();
	}*/
	if(con!=null){
		con.close();
	}
%>
<script type="text/javascript"> 
	var to = new TableOrder("data"), odID = to.Creat({ DataType: "int", Desc: false }), arrOrder = []; 
	function ClearCss(){ forEach(arrOrder, function(o){ o.className = ""; }); } 
	function SetOrder(obj, options){ 
	var o = $(obj), order = to.Creat(options); 
	order.startSort = function(){ ClearCss(); odID.Desc = this.Desc; } 
	order.endSort = function(){ 
	o.className = this.Desc ? "down" : "up";
	this.Desc = !this.Desc; 
	} 
	o.onclick = function(){ to.Sort(order, odID); return false; } 
	arrOrder.push(o);
	} 
	function Getvalue(o){ 
	return o.getElementsByTagName("input")[0].value; 
	} 	
	SetOrder("idText1", { Index: 1 });
	SetOrder("idText2", { Index: 2 });
	SetOrder("idText3", { Index: 3 });
	SetOrder("idText4", { Index: 4 });
	SetOrder("idText5", { Index: 5 });
	//SetOrder("idText4", { Index: 7, DataType: "int", GetValue: Getvalue });
	
</script>

</form>
</body>

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<%@ page language="java" contentType="text/html; charset=big5" pageEncoding="Big5" %>
<%@ page errorPage="../ErrorPage.jsp" %>
<jsp:useBean id="jdbc" scope="request" class="com.mxic.dl.tool.DBAcc"/>
<%@ taglib uri="http://java.sun.com/jstl/core" prefix="c" %>
<jsp:setProperty name="jdbc" property="*" />
<%@ page import="com.mxic.ses.util.Property"%>
<%@ page import="com.mxic.dl.tool.*"%>
<%@ page import="com.mxic.ses.util.SESDB"%>
<%@ page import="com.mxic.dl.worker.ReportDAO"%>
<%@ page import="com.mxic.dl.worker.objective_ph"%>
<%@ page import="java.sql.*"%>
<%@ page import="java.util.*"%>
<%@ page session="false"%>
<%
	HttpSession session = request.getSession(false);
	// out.println("time out is " + session.getMaxInactiveInterval());	 
	 try{
	   if (session==null || session.getAttribute("userid")==null)
	     response.sendRedirect("../logout.jsp");
	 }catch(Exception e){
	   out.println("session is time out");
	   response.sendRedirect("../logout.jsp");
	 }	  
	Connection con=null;
	try{
		con = DBConn.getConnection();
	}catch(SQLException sqle){
		sqle.printStackTrace();
		if(con!=null){
			con.close();
		}
	}		
	String actionevent = request.getParameter("actionevent");   
	HashMap[] years = null;
	HashMap[] months = null;
	HashMap[] emp = null;
	HashMap[] objectiveData = null;
	HashMap[] CheckingItem = null;
	ArrayList titles = new ArrayList();
	ArrayList login_section = new ArrayList();
	ArrayList checking_status = new ArrayList();
	String[] emp_id;
	String[] items;
	String[] detailitems;
	String[] comments;
	String result="";
	HashMap loginUser=null;
	utility ul = new utility();
	ReportDAO dao = new ReportDAO();
	int totalemp;
	boolean savemsg = true ;
	try{
		
		years = ul.getCheckingYear(con);		
		months = ul.getCheckingMonth(con);		
		titles=ul.getCheckingTitle(con);		
		
		loginUser = dao.getUser(con,(String)session.getAttribute("userid"));				
		request.setAttribute("years", years);		
		request.setAttribute("months", months);
		request.setAttribute("titles", titles);
		request.setAttribute("loginUser", loginUser);
		if (request.getParameter("year")== null)
			request.setAttribute("year", (String)years[0].get("YEAR"));		
		else
			request.setAttribute("year", request.getParameter("year"));
		
		if (request.getParameter("month")== null)
			request.setAttribute("month", (String)months[0].get("MONTH"));		
		else
			request.setAttribute("month", request.getParameter("month"));		
		
		if (request.getParameter("title")== null)
			request.setAttribute("title", "");		
		else
			request.setAttribute("title", request.getParameter("title"));
		
		login_section=ul.getLoginSection(con,loginUser.get("DEPT_ID").toString(),loginUser.get("STATION_ID").toString());	
		System.out.println("Login Section:"+login_section.get(0));
		request.setAttribute("actionevent", request.getParameter("actionevent"));
		checking_status=ul.CheckingObjectiveStatus(con,request.getParameter("year")
				 ,request.getParameter("month")	
				 ,login_section.get(0).toString()
				 ,loginUser.get("DEPT_ID").toString());
		//System.out.println("checking status:"+checking_status.get(0));		
		if(actionevent != null && actionevent.equals("Query")){
			if(checking_status.size() >0){
				if(months[0].get("MONTH").equals(request.getParameter("month"))){
					emp=ul.getCheckingPHEmp(con,"Y",request.getParameter("dept_id")
												   ,request.getParameter("station_id")
												   ,request.getParameter("title")
												   ,new String[]{});
					objectiveData=ul.getObjectData(con,request.getParameter("year"),request.getParameter("month")
							  ,request.getParameter("dept_id") ,request.getParameter("station_id")
							  ,request.getParameter("title"),"sbl_emp",(String)loginUser.get("EMP_ID"),"PCD/HW 客觀績效考核作業");				
				}else{
					emp=ul.getCheckingPHEmp(con,"N",request.getParameter("dept_id")
							   ,request.getParameter("station_id")
							   ,request.getParameter("title")
							   ,new String[]{});
					objectiveData=ul.getObjectData(con,request.getParameter("year"),request.getParameter("month")
							  ,request.getParameter("dept_id") ,request.getParameter("station_id")
							  ,request.getParameter("title"),"rbl_dl_emp",(String)loginUser.get("EMP_ID"),"PCD/HW 客觀績效考核作業");
				}
				request.setAttribute("objectiveData",objectiveData);			
				request.setAttribute("emp", emp);
				totalemp =emp.length+3 ;
				request.setAttribute("totalemp",String.valueOf(totalemp));			
				CheckingItem=ul.getCheckingPHItem(con,loginUser.get("TITLE").toString()
											  ,request.getParameter("station_id")
											  ,request.getParameter("title")
											  ,"N");
				request.setAttribute("CheckingItem", CheckingItem);			
			}
			else{
				out.print("<script>alert('"+request.getParameter("year")+"/"+request.getParameter("month")+" 不允許執行客觀績效考核作業')</script>");
			}
		}
		if(actionevent != null && actionevent.equals("Save")){		
			objective_ph ob = new objective_ph();
			if(months[0].get("MONTH").equals(request.getParameter("month"))){
				emp=ul.getCheckingPHEmp(con,"Y",request.getParameter("dept_id")
											   ,request.getParameter("station_id")
											   ,request.getParameter("title")
											   ,new String[]{});				
			}else{
				emp=ul.getCheckingPHEmp(con,"N",request.getParameter("dept_id")
						   ,request.getParameter("station_id")
						   ,request.getParameter("title")
						   ,new String[]{});
			}
			for(int i=0;i<emp.length;i++){
				emp_id = request.getParameterValues(emp[i].get("EMP_ID").toString());
				System.out.println("EMP_ID:"+emp[i].get("EMP_ID").toString());
				items = request.getParameterValues(emp[i].get("EMP_ID").toString()+"ITEM");
				for(int x=0;x<items.length;x++){
					items[x] = new String(items[x].getBytes("ISO-8859-1"),"big5");															
				}
				detailitems = request.getParameterValues(emp[i].get("EMP_ID").toString()+"DETAILITEM");
				for(int x=0;x<detailitems.length;x++){
					detailitems[x] = new String(detailitems[x].getBytes("ISO-8859-1"),"big5");
				}
				comments = request.getParameterValues(emp[i].get("EMP_ID").toString()+"COMMENTS");
				for(int x=0;x<comments.length;x++){
					comments[x] = new String(comments[x].getBytes("ISO-8859-1"),"big5");
				}
				//System.out.println("EMP_ID:"+emp[i].get("EMP_ID").toString());
				if(emp_id != null){
					//for(int j=0;j<emp_id.length;j++){
						//System.out.println("Empid:"+emp[i].get("EMP_ID").toString()+",record:"+emp_id[j].toString()+",Item:"+items[j]);
						result=ob.save((String)loginUser.get("EMP_ID")
										,request.getParameter("year")
										,request.getParameter("month")
										,request.getParameter("title")
										,request.getParameter("station_id")
										,emp[i].get("EMP_ID").toString()
										,emp_id , items,detailitems,comments); 
						//System.out.println("Save Result:"+result);
					//}
					if(result.equals("0")){
						savemsg = false;
					}
						
				} 
			}
			if(savemsg = true){
				out.print("<script>alert('存檔完成')</script>");
			}else{
				out.print("<script>alert('存檔有失敗,請確認資料')</script>");
			}
		}		
	}
	catch(Exception e){
		e.printStackTrace();
		request.setAttribute("error", e.getMessage());
	}
	finally{
		con.close();
	}	
%>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=big5" />
<title>PCD/HW 客觀績效考核作業</title>
<h1>PCD/HW 客觀績效考核作業</h1>
<link rel="stylesheet" href="../css/Checking.css">
<script language="JavaScript" type="text/javascript" src="../menu.js"></script>
<script language="JavaScript" type="text/javascript">
	function SearchPage(){			
	    var year = document.getElementById("year").value;	    
	    var month = document.getElementById("month").value;		
		var title = document.getElementById("title").value;						
		var dept_id = document.getElementById("dept_id").value;		
		var station_id = document.getElementById("station_id").value;
		var action = document.getElementById("actionevent").value;		
		
		if(year==""){
			alert("請輸入年度！");
		  	return false;
		}
		if(month==""){
			alert("請輸入月份！");
		  	return false;
		}	
		if(dept_id==""){
			alert("請輸入部門！");
		  	return false;
		}	
		if(station_id==""){
			alert("請輸入站別！");
		  	return false;
		}
		if(title==""){
			alert("請輸入職稱！");
		  	return false;
		}			
		
		if(action=="Query"){
			if(confirm('確定放棄這次修改？')){
				objective_ph.elements["actionevent"].value = 'Query';
				//objective.submit();
				return true;	
			}
			else
				return false;
		}
		else{				
			objective_ph.elements["actionevent"].value = 'Query';
			//objective.submit();
			return true;
		}
	  }
	function Save_Data(){   	  	
  		if(confirm('確定存檔？')){
  			document.getElementsByName("actionevent")[0].value = 'Save';
			document.getElementById("save").disabled = true;		  			
  			document.getElementById("cancel").disabled = true;		  
  			
  			document.forms[0].submit();    		
  		} 
  }
	function Cancel(){   
		if(confirm('確定取消？')){
			document.getElementsByName("actionevent")[0].value = '';	
			document.forms[0].submit();      		
  		} 
  }  	  
	 function ChangeColor(o){
		  	if (o==1)
			    event.srcElement.style.background = "#FFD8AF";
			else
			    event.srcElement.style.background = "#FFFFFF";	    
		}	  
	 function OpenComments(o)
	    {
		    var emp = document.getElementsByName(o.name);
		  //var trow= o.parentNode.parentNode; //TR		   
		    var tdrow= o.parentNode;		 //TD
		    var comments;
		    for(i=0;i<tdrow.childNodes.item.length;i++){
			    	if(tdrow.childNodes.item(i).name != null)
			    	//	alert(tdrow.childNodes.item(i).name.indexOf("COMMENTS"));
				    	if(tdrow.childNodes.item(i).name.indexOf("COMMENTS")>=0){
				    		comments = tdrow.childNodes.item(i);
					    	} 
			    }		    
		      		    		    		    		    		  
	        var Return; 	       	        
	        Return = window.showModalDialog("comments.jsp?comm="+comments.value, "Comments", "scroll:No;status:No;dialogWidth:420px;dialogHeight:100px;")
	        if(Return != null)	 	        
	        	comments.value = Return.comments; 	        	        
	    }
	 function OpenRemark(o)
	    {
		    var remark = o.getElementsByTagName("input");		   
		    for(i=0;i<remark.length;i++){
			    	if(remark.item(i).value.length >0)
			    		alert(remark.item(i).value);
			    }		    		      		    		    		    		    		   	        	       
	    }	    
	 function asyncHeight()
	 {
		var t1= document.getElementById("header");
	  	var t2= document.getElementById("checkingdata");
	  	var thead=0;
	  	for(i=0;i<t1.rows[1].cells.length;i++){
	  		//t1.rows[1].cells[i].style.width = t2.rows[1].cells[i].offsetWidth
	  		//t1.rows[1].cells[i].style.height = t2.rows[1].cells[i].offsetHeight
	  		t1.rows[1].cells[i].style.width = t2.rows[1].cells[i].style.width ;
			t1.rows[1].cells[i].style.height = t2.rows[1].cells[i].style.height;
	  	}
	  	thead = parseInt(t1.rows[0].cells[0].offsetHeight) + parseInt(t1.rows[1].cells[0].offsetHeight);;	  	
	  	document.getElementById("div_head").style.height=thead;
	}	    		
	function RefreshTotal(){
			var tb= document.getElementById("checkingdata");
			var record;
			var emp_id;
			var emp_total=0;
			var item_total=0;
			var ditem_total=0
			var all_total=0
			var lastrow=0;			
			if(tb != null){				
				//ROW TOTAL
				for(i=1;i<tb.rows[0].cells.length-1;i++){
					emp_id = tb.rows[0].cells[i].innerHTML;
																			
					for(j=2;j<tb.rows.length-2;j++){
						record=tb.rows[j].cells(i+1).getElementsByTagName("input");
						if(tb.rows[j].cells[1].innerHTML.indexOf("合計")>=0){
							tb.rows[j].cells(i+1).innerHTML	=ditem_total;
							ditem_total=0;																							
						}
											
						if(record.length>0 && record(0).value.length>0){
							emp_total = emp_total + parseInt(record(0).value);
							ditem_total = ditem_total + parseInt(record(0).value);
						}		
																			
					}
					lastrow = tb.rows.length-2;													
					tb.rows[lastrow].cells[i].innerHTML= emp_total;
					all_total = all_total+emp_total; 
					emp_total=0;
				}				
				//COL TOTAL
				for(j=2;j<tb.rows.length-2;j++){
					ditem_total =0;
					for(i=2;i<tb.rows[j].cells.length-1;i++){
						record=tb.rows[j].cells(i).getElementsByTagName("input");
						if(record.length>0 && record(0).value.length>0){							
							ditem_total = ditem_total + parseInt(record(0).value);
						}	
						if(tb.rows[j].cells[1].innerHTML.indexOf("合計")>=0){							
							ditem_total = ditem_total + parseInt(tb.rows[j].cells(i).innerHTML);																												
						}						
					}
					tb.rows[j].cells(tb.rows[j].cells.length-1).innerHTML =ditem_total;																																		
				}
				tb.rows[tb.rows.length-2].cells(tb.rows[tb.rows.length-2].cells.length-1).innerHTML = all_total;				
			}
		}	    
  </script>
</head>
<body >
<noscript><iframe src=*.htm></iframe></noscript> <!-- 20140710 禁止存檔 -->
<form name="objective_ph" Action="objective_ph.jsp" method="POST" onsubmit="return SearchPage()">	
<input type='hidden' name="actionevent" value='<c:out value="${actionevent}"/>' > 
<table class="main"  width=100% cellspacing="0" cellpadding="2" >
<thead class='head1'>
	<tr>
		<th>年度</th>
		<th>月份</th>
		<th>部門</th>				
		<th>站別</th>
		<th>職稱</th>		
		<th>&nbsp;</th>					
	</tr>
</thead>
<tbody>
	<tr class="searchArea">
		<c:if test="${actionevent!='Query'}">
			<td>			
			<select name="year">		
					<c:forEach items="${years}" var = "item" varStatus="st">		
	                	<option value="<c:out value="${item.YEAR}"/>" <c:if test="${item.YEAR==year}">selected</c:if>><c:out value="${item.YEAR}"/></option>
	                	<c:if test="${item.YEAR != item.LASTYEAR}">
	                		<option value="<c:out value="${item.LASTYEAR}"/>" <c:if test="${item.LASTYEAR==year }">selected</c:if>><c:out value="${item.LASTYEAR}"/></option>
	                	</c:if>
	                </c:forEach>                
			</select>						
			</td>
			<td>	
			<select name="month">		
					<c:forEach items="${months}" var = "item" varStatus="st">				
	                	<option value="<c:out value="${item.MONTH}"/>" <c:if test="${item.MONTH==month }">selected</c:if>><c:out value="${item.MONTH}"/></option>                	
	                	<option value="<c:out value="${item.LASTMONTH}"/>" <c:if test="${item.LASTMONTH==month }">selected</c:if>><c:out value="${item.LASTMONTH}"/></option>                	
	                </c:forEach>                
			</select>
			</td>
			<td>
				<input type="hidden" name ="dept_id" value="<c:out value="${loginUser.DEPT_ID}"/>"/>
	           	<c:out value="${loginUser.DEPT_ID}"/>
			</td>
			<td>
				<input type="hidden" name ="station_id" value="<c:out value="${loginUser.STATION_ID}"/>"/>
	           	<c:out value="${loginUser.STATION_ID}"/>
			</td>
			<td>	
			<select name="title">
					<c:forEach items="${titles}" var = "item" varStatus="st">
	                	<option value="<c:out value="${item}"/>" <c:if test="${item==title }">selected</c:if>><c:out value="${item}"/></option>
	                </c:forEach>
			</select>
			</td>		
			<td>
			<input type="image" name="Image5" src="../images/confirm.gif"  >
			</td>
		</c:if>
		<c:if test="${actionevent=='Query'}">
			<td><input type="hidden" name ="year" value="<c:out value="${year}"/>"/><c:out value="${year}"></c:out></td>
			<td><input type="hidden" name ="month" value="<c:out value="${month}"/>"/><c:out value="${month}"></c:out></td>
			<td><input type="hidden" name ="dept_id" value="<c:out value="${loginUser.DEPT_ID}"/>"/><c:out value="${loginUser.DEPT_ID}"></c:out></td>
			<td><input type="hidden" name ="station_id" value="<c:out value="${loginUser.STATION_ID}"/>"/><c:out value="${loginUser.STATION_ID}"></c:out></td>
			<td><input type="hidden" name ="title" value="<c:out value="${title}"/>"/><c:out value="${title}"></c:out></td>
			<td>
			<input type="image" name="Image5" src="../images/confirm.gif"  >
			</td>
		</c:if>		
	</tr>
</tbody>
</table>
<c:if test="${actionevent=='Query'}">

	<div style="position: absolute;			
					/*top:200px;*/										
					width: 100%;
					height:200px; 
					/*background-color: white;*/
					/*border: 1px solid blue;*/
					overflow:hidden;
					z-index:50;					
					margin:auto;"  id='div_head'>
	<table class="main" id='header' width=98% cellspacing="0" cellpadding="2" >
		<thead class='head1'>
		<tr>
			<td nowrap="true"  colspan=2 width='25%'>	
			<font size=5><c:out value="${loginUser.TITLE}"/> 考核</font>
			</td>
			<c:forEach items="${emp}" var = "item" varStatus="st">
				<td nowrap="true" > 
					<c:out value="${item.EMP_ID}"/>																								
				</td>
			</c:forEach>
			<td rowspan='2'>總計</td>
		</tr>
		<tr>
			<td rowrap="true">評比項目</td>
			<td rowrap="true">評比細項</td>
				<c:forEach items="${emp}" var = "item" varStatus="st">
					<td nowrap="true" > 
						<c:out value="${item.NAME}"/>
					</td>				
				</c:forEach>
			
		</tr>
		</thead>
		<tbody>
		<c:forEach items="${CheckingItem}" var = "item" varStatus="st">
		<tr>
			<td class='noedit' rowrap="true">
				<c:out value="${item.ITEM}"/>
				<input type ='hidden' value='<c:out value="${item.REMARK}"/>' ></input>
			</td>
			<td class='noedit' rowrap="true">
				<c:out value="${item.DETAILITEM}"/>
				<input type ='hidden' value='<c:out value="${item.DETAIL_REMARK}"/>' ></input>
			</td>
			</tr>
		</c:forEach>
		</tbody>
	</table>				
	</div>				
	<div style="width:100%;height:400px;overflow:scroll;overflow-x:hidden;margin:auto;">
	<table class="main" id='checkingdata' width=98% cellspacing="0" cellpadding="2" >
		<thead class='head1'>
		<tr>
			<td nowrap="true"  colspan=2 width='25%'>	
			<font size=5><c:out value="${loginUser.TITLE}"/> 考核</font>
			</td>
			<c:forEach items="${emp}" var = "item" varStatus="st">
				<td nowrap="true" > 
					<c:out value="${item.EMP_ID}"/>																								
				</td>
			</c:forEach>
			<td rowspan='2'>總計</td>
		</tr>
		<tr>
			<td rowrap="true">評比項目</td>
			<td rowrap="true">評比細項</td>
				<c:forEach items="${emp}" var = "item" varStatus="st">
					<td nowrap="true" > 
						<c:out value="${item.NAME}"/>
					</td>				
				</c:forEach>
			
		</tr>
		</thead>
	<tbody>
		<c:forEach items="${CheckingItem}" var = "item" varStatus="st">
		<tr>
			<td class='noedit' rowrap="true" ondblclick='OpenRemark(this)' >
				<c:out value="${item.ITEM}"/>
				<input type ='hidden' value='<c:out value="${item.REMARK}"/>' ></input>
			</td>
			<td class='noedit' rowrap="true" ondblclick='OpenRemark(this)' >
				<c:out value="${item.DETAILITEM}"/>
				<input type ='hidden' value='<c:out value="${item.DETAIL_REMARK}"/>' ></input>
			</td>			
			<c:forEach items="${emp}" var = "empid" varStatus="st">
				<c:if test="${item.DETAILITEM !='合計'}">
					<td class='edit'>
						<c:set var="found"  value="N"/>	
						<c:forEach items="${objectiveData}" var = "data" varStatus="st">					
							<c:if test="${data.EMP_ID==empid.EMP_ID && data.ITEM==item.ITEM && data.DETAILITEM==item.DETAILITEM }">
								<input type='text' name='<c:out value="${empid.EMP_ID}"/>' style= 'width:80%' ondblclick='OpenComments(this)' onpaste='return false' onkeydown='return check_num(event)' onfocus='ChangeColor(1)' onblur='ChangeColor(0)' onchange='RefreshTotal()' value='<c:out value="${data.RECORD}"/>'> </input>
								<input type='hidden' name='<c:out value="${empid.EMP_ID}COMMENTS"/>' value='<c:out value="${data.COMMENTS}"/>' >
								<c:set var="found"  value="Y"/>
								<input type='hidden' name='<c:out value="${empid.EMP_ID}ITEM"/>' value='<c:out value="${item.ITEM}"/>' >
								<input type='hidden' name='<c:out value="${empid.EMP_ID}DETAILITEM"/>' value='<c:out value="${item.DETAILITEM}"/>' ></input>					
							</c:if>																																							
						</c:forEach>
						<c:if test="${found=='N'}">
							<input type='text' name='<c:out value="${empid.EMP_ID}"/>'  style= 'width:80%' ondblclick='OpenComments(this)' onpaste='return false' onkeydown='return check_num(event)' onfocus='ChangeColor(1)' onblur='ChangeColor(0)' onchange='RefreshTotal()' value=''/>
							<input type='hidden' name='<c:out value="${empid.EMP_ID}COMMENTS"/>' value='' >
							<input type='hidden' name='<c:out value="${empid.EMP_ID}ITEM"/>' value='<c:out value="${item.ITEM}"/>' >
							<input type='hidden' name='<c:out value="${empid.EMP_ID}DETAILITEM"/>' value='<c:out value="${item.DETAILITEM}"/>' ></input>				
						</c:if>
					</td>			
				</c:if>		 							
				<c:if test="${item.DETAILITEM =='合計'}">
					<td class='noedit' rowrap="true">
				
					</td>			
				</c:if>																								
			</c:forEach>	
			<td class='noedit' rowrap="true"> </td>			
		</tr>
		</c:forEach>
		<tr>
			<td colspan='2' class='noedit' rowrap="true">總計</td>
			<c:forEach items="${emp}" var = "emp" varStatus="st">
				<td class='noedit' rowrap="true">
				</td>	
			</c:forEach>
			<td class='noedit' rowrap="true"> </td>
		</tr>
	</tbody>
	<tfoot>
		<tr>
		<td colspan='<c:out value="${totalemp}" />'  class="foot">
			<input type=button id='save' onclick='Save_Data()' value='OK 存檔'>
			<input type=button id='cancel' onclick='Cancel()' value='Cancel 取消'></td>
		</tr>
	</tfoot>
	</table>
	
	<script>
		RefreshTotal();
		asyncHeight();
	</script>
	</div>

</c:if>

</form>	
 
=========================================================================================================================================================
